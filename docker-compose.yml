version: '3.8'

# ECI Platform - 3 Services Integration
# Order Service (MySQL) + Payment Service (PostgreSQL) + Shipping Service (PostgreSQL)
# Updated: November 6, 2025

networks:
  eci-network:
    driver: bridge
    name: eci-network

volumes:
  order-mysql-data:
  shipping-postgres-data:
  payment-postgres-data:

services:
  # ==================== ORDER SERVICE (MySQL) ====================
  order-mysql:
    image: mysql:8.0
    container_name: order-mysql
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: orders_db
      MYSQL_USER: orders_user
      MYSQL_PASSWORD: orders_pass
    volumes:
      - order-mysql-data:/var/lib/mysql
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpass"]
      interval: 10s
      timeout: 5s
      retries: 5

  order-service:
    build:
      context: ../eci-order-service
      dockerfile: Dockerfile
    container_name: order-service
    ports:
      - "8081:8000"
    environment:
      MYSQL_HOST: order-mysql
      MYSQL_PORT: 3306
      MYSQL_DATABASE: orders_db
      MYSQL_USER: orders_user
      MYSQL_PASSWORD: orders_pass
      SERVICE_PORT: 8000
      # Service URLs
      PAYMENT_SERVICE_URL: http://payment-service:8000
      SHIPPING_SERVICE_URL: http://shipping-service:8000
      INVENTORY_SERVICE_URL: http://inventory-service:8000
      CATALOG_SERVICE_URL: http://catalog-service:8000
    depends_on:
      order-mysql:
        condition: service_healthy
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ==================== PAYMENT SERVICE (PostgreSQL) ====================
  payment-postgres:
    image: postgres:14-alpine
    container_name: payment-postgres
    ports:
      - "5434:5432"
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: payment_db
    volumes:
      - payment-postgres-data:/var/lib/postgresql/data
      - ../eci-payment-service/db/init_with_seed.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - eci-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d payment_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  payment-service:
    build:
      context: ../eci-payment-service
      dockerfile: Dockerfile
    container_name: payment-service
    ports:
      - "8086:8006"
    environment:
      DATABASE_URL: "postgresql://user:password@payment-postgres:5432/payment_db"
      LOG_LEVEL: "INFO"
      SERVICE_NAME: payment-service
      SERVICE_PORT: 8006
      # Service URLs
      ORDER_SERVICE_URL: http://order-service:8000
      INVENTORY_SERVICE_URL: http://inventory-service:8000
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
    depends_on:
      payment-postgres:
        condition: service_healthy
      order-service:
        condition: service_healthy
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ==================== SHIPPING SERVICE (PostgreSQL) ====================
  shipping-postgres:
    image: postgres:14-alpine
    container_name: shipping-postgres
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: shipping_db
    volumes:
      - shipping-postgres-data:/var/lib/postgresql/data
      - ../eci-shipping-service/db/init_with_seed.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - eci-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d shipping_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  shipping-service:
    build:
      context: ../eci-shipping-service
      dockerfile: Dockerfile
    container_name: shipping-service
    ports:
      - "8085:8005"
    environment:
      DATABASE_URL: "postgresql://user:password@shipping-postgres:5432/shipping_db"
      LOG_LEVEL: "INFO"
      SERVICE_NAME: shipping-service
      SERVICE_PORT: 8005
      # Service URLs
      ORDER_SERVICE_URL: http://order-service:8000
      INVENTORY_SERVICE_URL: http://inventory-service:8000
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
    depends_on:
      shipping-postgres:
        condition: service_healthy
      order-service:
        condition: service_healthy
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

