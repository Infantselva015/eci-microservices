version: '3.8'

# ECI Platform - 5 Services Integration
# Catalog Service (Node.js/MySQL) + Inventory Service (Node.js/MySQL) + Order Service (Python/MySQL)
# Payment Service (Python/PostgreSQL) + Shipping Service (Python/PostgreSQL)
# Updated: November 8, 2025

networks:
  eci-network:
    driver: bridge
    name: eci-network

volumes:
  catalog-mysql-data:
  inventory-mysql-data:
  order-mysql-data:
  payment-postgres-data:
  shipping-postgres-data:

services:
  # ==================== CATALOG SERVICE (Node.js/MySQL) ====================
  catalog-mysql:
    image: mysql:8.4
    container_name: catalog-mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: toor
      MYSQL_DATABASE: catalog_db
    volumes:
      - catalog-mysql-data:/var/lib/mysql
      - ./eci-catalog-service/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-ptoor"]
      interval: 10s
      timeout: 5s
      retries: 5

  catalog-service:
    build:
      context: ./eci-catalog-service
      dockerfile: Dockerfile
    container_name: catalog-service
    ports:
      - "8090:8080"
    environment:
      PORT: 8080
      API_VERSION: v1
      DB_HOST: catalog-mysql
      DB_PORT: 3306
      DB_NAME: catalog_db
      DB_USER: root
      DB_PASSWORD: toor
      NODE_ENV: production
    depends_on:
      catalog-mysql:
        condition: service_healthy
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ==================== INVENTORY SERVICE (Node.js/MySQL) ====================
  inventory-mysql:
    image: mysql:8.0
    container_name: inventory-mysql
    ports:
      - "3308:3306"
    environment:
      MYSQL_ROOT_PASSWORD: toor
      MYSQL_DATABASE: inventory_db
    volumes:
      - inventory-mysql-data:/var/lib/mysql
      - ./eci-inventory-service/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-ptoor"]
      interval: 10s
      timeout: 5s
      retries: 5

  inventory-service:
    build:
      context: ./eci-inventory-service
      dockerfile: Dockerfile
    container_name: inventory-service
    ports:
      - "8081:8081"
    environment:
      PORT: 8081
      API_VERSION: v1
      DB_HOST: inventory-mysql
      DB_PORT: 3306
      DB_NAME: inventory_db
      DB_USER: root
      DB_PASSWORD: toor
      NODE_ENV: production
      RESERVATION_TTL_MINUTES: 15
      CATALOG_SERVICE_URL: http://catalog-service:8080
    depends_on:
      inventory-mysql:
        condition: service_healthy
      catalog-service:
        condition: service_healthy
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ==================== ORDER SERVICE (Python/MySQL) ====================
  order-mysql:
    image: mysql:8.0
    container_name: order-mysql
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: orders_db
      MYSQL_USER: orders_user
      MYSQL_PASSWORD: orders_pass
    volumes:
      - order-mysql-data:/var/lib/mysql
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpass"]
      interval: 10s
      timeout: 5s
      retries: 5

  order-service:
    build:
      context: ./eci-order-service
      dockerfile: Dockerfile
    container_name: order-service
    ports:
      - "8082:8000"
    environment:
      MYSQL_HOST: order-mysql
      MYSQL_PORT: 3306
      MYSQL_DATABASE: orders_db
      MYSQL_USER: orders_user
      MYSQL_PASSWORD: orders_pass
      SERVICE_PORT: 8000
      # Service URLs
      PAYMENT_URL: http://payment-service:8006
      SHIPPING_URL: http://shipping-service:8005
      INVENTORY_URL: http://inventory-service:8081
      CATALOG_URL: http://catalog-service:8080
    depends_on:
      order-mysql:
        condition: service_healthy
      catalog-service:
        condition: service_healthy
      inventory-service:
        condition: service_healthy
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ==================== PAYMENT SERVICE (Python/PostgreSQL) ====================
  payment-postgres:
    image: postgres:14-alpine
    container_name: payment-postgres
    ports:
      - "5434:5432"
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: payment_db
    volumes:
      - payment-postgres-data:/var/lib/postgresql/data
      - ./eci-payment-service/db/init_with_seed.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - eci-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d payment_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  payment-service:
    build:
      context: ./eci-payment-service
      dockerfile: Dockerfile
    container_name: payment-service
    ports:
      - "8086:8006"
    environment:
      DATABASE_URL: "postgresql://user:password@payment-postgres:5432/payment_db"
      LOG_LEVEL: "INFO"
      SERVICE_NAME: payment-service
      SERVICE_PORT: 8006
      # Service URLs
      ORDER_SERVICE_URL: http://order-service:8000
      INVENTORY_SERVICE_URL: http://inventory-service:8081
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
    depends_on:
      payment-postgres:
        condition: service_healthy
      order-service:
        condition: service_healthy
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ==================== SHIPPING SERVICE (Python/PostgreSQL) ====================
  shipping-postgres:
    image: postgres:14-alpine
    container_name: shipping-postgres
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: shipping_db
    volumes:
      - shipping-postgres-data:/var/lib/postgresql/data
      - ./eci-shipping-service/db/init_with_seed.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - eci-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d shipping_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  shipping-service:
    build:
      context: ./eci-shipping-service
      dockerfile: Dockerfile
    container_name: shipping-service
    ports:
      - "8085:8005"
    environment:
      DATABASE_URL: "postgresql://user:password@shipping-postgres:5432/shipping_db"
      LOG_LEVEL: "INFO"
      SERVICE_NAME: shipping-service
      SERVICE_PORT: 8005
      # Service URLs
      ORDER_SERVICE_URL: http://order-service:8000
      INVENTORY_SERVICE_URL: http://inventory-service:8081
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
    depends_on:
      shipping-postgres:
        condition: service_healthy
      order-service:
        condition: service_healthy
    networks:
      - eci-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
